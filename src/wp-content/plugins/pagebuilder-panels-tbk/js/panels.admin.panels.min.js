/*
 GPL 2.0 http://www.gnu.org/licenses/gpl-2.0.html
*/
(function(a){var k=0;panels.undoManager=new UndoManager;a.fn.getPanelData=function(){var e=a(this),d={};e.find(".form *[name]").not("[data-info-field]").each(function(){var b=/widgets\[[0-9]+\]\[([a-z0-9_]+)\]/.exec(a(this).attr("name")),b=b[1];d[b]="checkbox"==e.attr("type")?a(this).is(":checked"):a(this).val()});return d};a.fn.panelsCreatePanel=function(e,d){var b=a(this).find('.panel-type[data-class="'+e+'"]');if(0==b.length)return null;a("#panels-undo-message").fadeOut(function(){a(this).remove()});
var f=a('<div class="panel new-panel"><div class="panel-wrapper"><div class="title"><h4></h4><span class="actions"></span></div><small class="description"></small><div class="form"></div></div></div>').attr("data-type",e),g,h=b.attr("data-form"),h=h.replace(/\{\$id\}/g,k++);f.data({"title-field":b.attr("data-title-field"),title:b.attr("data-title")}).find("h4, h5").click(function(){g.dialog("open");return!1}).end().find(".description").html(b.find(".description").html()).end().find(".form").html(h);
var j={},l=function(){panels.undoManager.register(this,function(b,d,e,f){b=a("#panels-dialog").panelsCreatePanel(b,d,e);panels.addPanel(b,e,f,!0);a("#panels-container .panel").removeClass("new-panel")},[f.attr("data-type"),f.getPanelData(),f.closest(".panels-container"),f.index()],"Remove Panel");a("#panels-undo-message").remove();a('<div id="panels-undo-message" class="updated"><p>'+panels.i10n.messages.deleteWidget+' - <a href="#" class="undo">'+panels.i10n.buttons.undo+"</a></p></div>").appendTo("body").hide().slideDown().find("a.undo").click(function(){panels.undoManager.undo();
a("#panels-undo-message").fadeOut(function(){a(this).remove()});return!1});f.slideUp(function(){a(this).remove();a("#panels-container .panels-container").trigger("refreshcells")});g.dialog("close")};j[panels.i10n.buttons.done]=function(){a(this).trigger("panelsdone");g.find("*[name]").not("[data-info-field]").each(function(){var b=f.find('.form *[name="'+a(this).attr("name")+'"]');"checkbox"==b.attr("type")?b.prop("checked",a(this).is(":checked")):b.val(a(this).val())});f.panelsSetPanelTitle();g.dialog("close")};
g=a('<div class="panel-dialog dialog-form"></div>').html(h).dialog({dialogClass:"panels-admin-dialog",autoOpen:!1,modal:!0,title:panels.i10n.messages.editWidget.replace("%s",b.attr("data-title")),minWidth:700,maxHeight:Math.round(0.925*a(window).height()),create:function(){a(this).closest(".ui-dialog").find(".show-in-panels").show()},open:function(){f.find(".form *[name]").not("[data-info-field]").each(function(){var b=g.find('*[name="'+a(this).attr("name")+'"]');"checkbox"==b.attr("type")?b.prop("checked",
a(this).is(":checked")):b.val(a(this).val())});a(this).trigger("panelsopen");a(this).closest(".ui-dialog").find("a").blur()},buttons:j}).keypress(function(b){if(b.keyCode==a.ui.keyCode.ENTER){if(!(0<a(this).closest(".ui-dialog").find("textarea:focus").length))return a(this).closest(".ui-dialog").find(".ui-dialog-buttonpane .ui-button:eq(0)").click(),b.preventDefault(),!1}else b.keyCode===a.ui.keyCode.ESCAPE&&(console.log("here"),a(this).closest(".ui-dialog").dialog("close"))});f.data("dialog",g);
g.find("label").each(function(){var b=a("#"+a(this).attr("for"));a(this).disableSelection();a(this).click(function(){"checkbox"==b.attr("type")?b.prop("checked",!b.prop("checked")):b.focus()})});f.disableSelection();f.find(".title .actions").append(a("<a>edit<a>").addClass("edit").click(function(){g.dialog("open");return!1})).append(a("<a>delete<a>").addClass("delete").click(function(){l();return!1}));if(void 0!=d)for(c in d)"info"!=c&&(b=f.find('.form *[name$="['+c+']"]'),h=g.find('*[name$="['+c+
']"]'),"checkbox"==b.attr("type")?(b.prop("checked",Boolean(d[c])),h.prop("checked",Boolean(d[c]))):(b.val(d[c]),h.val(d[c])));f.panelsSetPanelTitle();a(window).resize();return f};panels.addPanel=function(e,d,b,f){null==d&&(d=a("#panels-container .cell.cell-selected .panels-container").eq(0));0==d.length&&(d=a("#panels-container .cell .panels-container").eq(0));0!=d.length&&(null==b?d.append(e):(b=d.find(".panel").eq(b),0==b.length?d.append(e):e.insertBefore(b)),d.sortable("refresh").trigger("refreshcells"),
d.closest(".grid-container").panelsResizeCells(),f&&a("#panels-container .panel.new-panel").hide().slideDown(500,function(){e.data("dialog").dialog("open")}).removeClass("new-panel"))};a.fn.panelsSetPanelTitle=function(){return a(this).each(function(){var e=a(this).find('input[type="text"]').eq(0).val();a(this).find("h4").html(a(this).data("title")+"<span>"+e+"</span>")})};panels.loadPanels=function(e){panels.clearGrids();for(var d in e.grids){var b=[],f;for(f in e.grid_cells)Number(e.grid_cells[f].grid)==
d&&(b[b.length]=Number(e.grid_cells[f].weight));var b=panels.createGrid(Number(e.grids[d].cells),b),g;for(g in e.widgets)if(Number(e.widgets[g].info.grid)==d){var h=e.widgets[g],h=a("#panels-dialog").panelsCreatePanel(h.info["class"],h);b.find(".panels-container").eq(Number(e.widgets[g].info.cell)).append(h)}}a("#panels-container .panels-container").sortable("refresh").trigger("refreshcells");a("#panels-container .panel").removeClass("new-panel");a("#panels-container .grid-container").each(function(){a(this).panelsResizeCells()})}})(jQuery);